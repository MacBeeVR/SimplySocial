trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: Build
  displayName: 'Build App'

  variables:
    BuildConfiguration: 'Release'
    BuildProject: '**/SimplySocial.Server.csproj'

  jobs: 
  - job: Build
    steps:
    - task: UseDotNet@2
      displayName: 'Use .Net 5 SDK'
      inputs:
        version: 5.0.x
        packageType: sdk
        includePreviewVersions: false
        installationPath: $(Agent.ToolsDirectory)/dotnet
    - task: DotNetCoreCLI@2
      displayName: 'Use dotnet ef'
      inputs:
        command: custom
        custom: 'tool '
        arguments: install --global dotnet-ef
    - task: DotNetCoreCLI@2
      displayName: Restore
      inputs:
        command: restore
        projects: $(BuildProject)
    - task: DotNetCoreCLI@2
      displayName: Build
      inputs:
        projects: $(BuildProject)
        arguments: --configuration $(BuildConfiguration)
    - task: DotNetCoreCLI@2
      displayName: 'Create Identity SQL'
      inputs:
        command: custom
        custom: 'ef '
        arguments: migrations script --output $(Build.ArtifactStagingDirectory)/SQL/identity.sql --idempotent --project $(Build.SourcesDirectory)/src/Server/SimplySocial.Server.csproj --context IdentityContext
    - task: DotNetCoreCLI@2
      displayName: Publish
      inputs:
        command: publish
        zipAfterPublish: true
        publishWebProjects: true
        projects: '$(BuildProject)'
        arguments: '--configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory)/SimplySocialApp'
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Artifact'
      condition: succeededOrFailed()
      inputs:
        artifactName: SimplySocialApp
        targetPath: '$(Build.ArtifactStagingDirectory)/SimplySocialApp'
    - task: PublishPipelineArtifact@1
      displayName: 'Publish SQL Scripts'
      inputs:
        artifactName: SQLScripts
        targetPath: '$(Build.ArtifactStagingDirectory)/SQL'

- stage: Deploy
  displayName: Deploy

  jobs:
    - job: DeployApp
      displayName: 'Deploy App'
      steps:
        - task: DownloadPipelineArtifact@2
          displayName: 'Download Artifact'
          inputs:
            artifactName: SimplySocialApp
            path: '$(Pipeline.Workspace)/SimplySocialApp'
        
        - task: AzureWebApp@1
          displayName: 'Deploy to App Service'
          inputs:
            appName: sealsdev
            appType: webAppLinux
            azureSubscription: 'Free Azure Subscription (c7fc2dfb-f735-47e8-8b65-66057b28a6de)'
            package: '$(Pipeline.Workspace)/SimplySocialApp/Server.zip'
        

    - job: DeployDatabase
      displayName: 'Deploy Database'
      pool:
        vmImage: 'windows-latest'
      steps:
        - task: DownloadPipelineArtifact@2
          displayName: 'Download SQL Scripts'
          inputs:
            artifactName: SQLScripts
            path: '$(Pipeline.Workspace)\SQL'
        
        - task: SqlDacpacDeploymentOnMachineGroup@0
          inputs:
            TaskType: 'sqlQuery'
            ExclusiveLock: true
            ExecuteInTransaction: true
            AppLockName: '$(DBLock)'
            ServerName: '$(DBServer)'
            DatabaseName: '$(DBName)'
            SqlUsername: '$(DBUsername)'
            SqlPassword: '$(DBPassword)'
            SqlFile: '$(Pipeline.Workspace)\SQL\identity.sql'
            AuthScheme: 'sqlServerAuthentication'